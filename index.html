<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ホワイトアウトサバイバル 集結ツール</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- デザイン設定 --- */
      :root {
        --primary-color: #4092ff;
        --secondary-color: #6c757d;
        --danger-color: #f75555;
        --background-color: #1f2129;
        --surface-color: #2a2d38;
        --text-color: #e0e0e0;
        --border-color: #3b3f4d;
        --border-radius: 8px;
        --font-family: "Noto Sans JP", sans-serif;
      }
      /* --- 基本レイアウト --- */
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-family);
        background-color: var(--background-color);
        color: var(--text-color);
      }
      .container {
        max-width: 400px;
        min-height: 100vh;
        margin: 0 auto;
        background-color: #23252d;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
      }
      .content-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .page {
        padding: 15px;
        box-sizing: border-box;
        flex-grow: 1;
      }
      .page-title {
        text-align: center;
        color: #fff;
        margin-top: 0;
        margin-bottom: 16px;
        font-size: 1.3em;
      }
      .footer {
        text-align: center;
        font-size: 0.8em;
        color: #888;
        padding: 10px;
        border-top: 1px solid var(--border-color);
        flex-shrink: 0;
      }
      /* --- UIコンポーネント --- */
      .input-group {
        margin-bottom: 8px;
      }
      label {
        display: block;
        margin-bottom: 3px;
        font-weight: 700;
        font-size: 0.9em;
      }
      input[type="text"],
      input[type="time"],
      select {
        padding: 9px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-sizing: border-box;
        font-size: 1em;
        font-family: var(--font-family);
        width: 100%;
        background-color: var(--surface-color);
        color: var(--text-color);
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }
      .btn {
        width: 100%;
        padding: 10px;
        color: white;
        border: none;
        border-radius: var(--border-radius);
        font-size: 1em;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.1s, filter 0.1s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .btn-primary {
        background-color: var(--primary-color);
      }
      .btn-secondary {
        background-color: var(--secondary-color);
      }
      .btn-danger {
        background-color: var(--danger-color);
      }
      .btn:active {
        transform: scale(0.98);
        filter: brightness(0.9);
      }
      .link-button {
        font-size: 0.9em;
        color: var(--primary-color);
        cursor: pointer;
        border: none;
        background: none;
        padding: 5px;
      }
      .player-input-container {
        background-color: var(--surface-color);
        border: 1px solid #485c7d;
        border-radius: var(--border-radius);
        padding: 12px;
        margin-bottom: 10px;
        position: relative;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .remove-player-btn {
        position: absolute;
        top: -8px; /* 上に少しはみ出すように調整 */
        right: -8px; /* 右に少しはみ出すように調整 */
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: var(--danger-color);
        color: white;
        font-size: 1.2em;
        font-weight: bold;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 2px solid var(--background-color); /* 背景色と同じボーダーを追加 */
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .result-list {
        margin-top: 20px;
        padding: 0;
        list-style: none;
      }
      .result-item {
        background-color: #3b3f4d;
        padding: 10px;
        border-radius: var(--border-radius);
        margin-bottom: 8px;
        font-weight: bold;
        color: #fff;
      }
      .radio-group {
        display: flex;
        gap: 20px;
      }
      .radio-group input {
        width: auto;
      }
      .radio-group label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: normal;
        margin-bottom: 0;
      }
      .input-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }
      .input-row .input-group {
        flex-grow: 1;
        margin-bottom: 0;
      }
      .time-select-group {
        display: flex;
        gap: 5px;
      }
      .time-select-group select {
        flex: 1;
        background-color: #3b3f4d;
        color: #e0e0e0;
      }
      #utc-timer {
        font-size: 1.2em;
        text-align: center;
        margin-bottom: 15px;
        font-weight: bold;
        color: #40c0ff;
      }
      #copy-button {
        margin-top: 10px;
      }
      .player-input-container .input-row {
        margin-top: 0px;
      }
      .player-input-container .input-row .input-group:first-child {
        flex: 2;
      }
      .player-input-container .input-row .input-group:last-child {
        flex: 1.5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="content-wrapper">
        <main id="page-main" class="page">
          <h1 class="page-title">
            ホワイトアウトサバイバル<br />集結攻撃ツール
          </h1>
          <div id="utc-timer"></div>

          <div id="player-inputs"></div>

          <button id="add-player-btn" class="btn btn-secondary">
            + プレイヤーを追加
          </button>

          <div class="input-group" style="margin-top: 20px">
            <label>集結待機時間</label>
            <div class="radio-group">
              <label
                ><input type="radio" name="rally-time" value="300" checked />
                5分</label
              >
              <label
                ><input type="radio" name="rally-time" value="60" /> 1分</label
              >
            </div>
          </div>

          <div class="input-group">
            <label for="arrival-time">目標着弾時間</label>
            <input type="time" step="1" id="arrival-time" />
          </div>

          <div class="button-group">
            <button id="btn-reset" class="btn btn-danger">リセット</button>
            <button id="btn-calculate" class="btn btn-primary">計算</button>
          </div>

          <div id="result-area">
            <ul id="result-list" class="result-list"></ul>
            <button
              id="copy-button"
              class="btn btn-secondary"
              style="display: none"
            >
              チャットにコピー
            </button>
          </div>
        </main>
      </div>
      <footer class="footer">© ゲームツール</footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const playerInputsContainer = document.getElementById("player-inputs");
        const addPlayerBtn = document.getElementById("add-player-btn");
        const calculateBtn = document.getElementById("btn-calculate");
        const resetBtn = document.getElementById("btn-reset");
        const arrivalTimeInput = document.getElementById("arrival-time");
        const resultList = document.getElementById("result-list");
        const utcTimerDisplay = document.getElementById("utc-timer");
        const copyButton = document.getElementById("copy-button");

        let playerCount = 0;
        let calculatedResults = [];

        // UTCタイマーを更新する関数
        const updateUTCTime = () => {
          const now = new Date();
          const utcHours = now.getUTCHours();
          const utcMinutes = now.getUTCMinutes();
          const utcSeconds = now.getUTCSeconds();
          utcTimerDisplay.textContent = `現在UTC時刻: ${String(
            utcHours
          ).padStart(2, "0")}:${String(utcMinutes).padStart(2, "0")}:${String(
            utcSeconds
          ).padStart(2, "0")}`;
        };

        // 1秒ごとにタイマーを更新
        setInterval(updateUTCTime, 1000);
        updateUTCTime(); // 初回表示

        // ドロップダウンのオプションを生成するヘルパー関数
        const createTimeOptions = (limit) => {
          let options = "";
          for (let i = 0; i <= limit; i++) {
            options += `<option value="${i}">${String(i).padStart(
              2,
              "0"
            )}</option>`;
          }
          return options;
        };

        // プレイヤー入力フォームを生成する関数
        const createPlayerInput = () => {
          playerCount++;
          const div = document.createElement("div");
          div.className = "player-input-container";
          div.innerHTML = `
            <button class="remove-player-btn" type="button">－</button>
            <div class="input-row">
              <div class="input-group">
                <input type="text" class="player-name" placeholder="プレイヤー ${playerCount}" />
              </div>
              <div class="input-group">
                <div class="time-select-group">
                  <select class="marching-time min-select">
                    ${createTimeOptions(59)}
                  </select>
                  <select class="marching-time sec-select">
                    ${createTimeOptions(59)}
                  </select>
                </div>
              </div>
            </div>
          `;
          return div;
        };

        // 最初のプレイヤー入力フォームを追加
        playerInputsContainer.appendChild(createPlayerInput());

        // プレイヤー追加ボタン
        addPlayerBtn.addEventListener("click", () => {
          playerInputsContainer.appendChild(createPlayerInput());
        });

        // プレイヤー削除ボタン
        playerInputsContainer.addEventListener("click", (e) => {
          if (e.target.classList.contains("remove-player-btn")) {
            e.target.closest(".player-input-container").remove();
            // プレイヤー番号を振り直す
            document
              .querySelectorAll(".player-input-container")
              .forEach((el, index) => {
                el.querySelector(".player-name").placeholder = `プレイヤー ${
                  index + 1
                }`;
              });
            playerCount = document.querySelectorAll(
              ".player-input-container"
            ).length;
          }
        });

        // 行軍時間を秒に変換する関数
        const getMarchingSeconds = (playerDiv) => {
          const minutes = parseInt(
            playerDiv.querySelector(".min-select").value
          );
          const seconds = parseInt(
            playerDiv.querySelector(".sec-select").value
          );
          return minutes * 60 + seconds;
        };

        // 時間文字列（HH:MM:SS）を秒に変換する関数
        const arrivalTimeToSeconds = (timeStr) => {
          const parts = timeStr.split(":");
          if (parts.length !== 3) return NaN;
          const hours = parseInt(parts[0]);
          const minutes = parseInt(parts[1]);
          const seconds = parseInt(parts[2]);
          if (
            isNaN(hours) ||
            isNaN(minutes) ||
            isNaN(seconds) ||
            hours < 0 ||
            hours > 23 ||
            minutes < 0 ||
            minutes > 59 ||
            seconds < 0 ||
            seconds > 59
          )
            return NaN;
          return hours * 3600 + minutes * 60 + seconds;
        };

        // 秒を時間文字列（HH:MM:SS）に変換する関数
        const secondsToTime = (totalSeconds) => {
          const hours = Math.floor(totalSeconds / 3600) % 24;
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;
          return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(
            2,
            "0"
          )}:${String(seconds).padStart(2, "0")}`;
        };

        // 計算ボタン
        calculateBtn.addEventListener("click", () => {
          resultList.innerHTML = "";
          calculatedResults = [];
          const rallyTime = parseInt(
            document.querySelector('input[name="rally-time"]:checked').value
          );
          const arrivalSeconds = arrivalTimeToSeconds(arrivalTimeInput.value);

          if (isNaN(arrivalSeconds)) {
            alert("有効な目標着弾時間を入力してください (HH:MM:SS)。");
            copyButton.style.display = "none";
            return;
          }

          const players = document.querySelectorAll(".player-input-container");
          players.forEach((playerDiv, index) => {
            const nameInput = playerDiv.querySelector(".player-name");

            const playerName = nameInput.value || `プレイヤー ${index + 1}`;
            const marchingSeconds = getMarchingSeconds(playerDiv);

            // 計算
            let departureSeconds = arrivalSeconds - marchingSeconds - rallyTime;

            // 日付をまたぐ場合の調整
            if (departureSeconds < 0) {
              departureSeconds += 24 * 3600;
            }

            const departureTimeFormatted = secondsToTime(departureSeconds);
            calculatedResults.push({
              name: playerName,
              time: departureTimeFormatted,
            });

            const resultItem = document.createElement("li");
            resultItem.className = "result-item";

            resultItem.textContent = `${
              index + 1
            }. ${playerName} の集結開始時間: ${departureTimeFormatted}`;
            resultList.appendChild(resultItem);
          });

          if (calculatedResults.length > 0) {
            copyButton.style.display = "block";
          }
        });

        // リセットボタン
        resetBtn.addEventListener("click", () => {
          playerInputsContainer.innerHTML = "";
          playerCount = 0;
          playerInputsContainer.appendChild(createPlayerInput());
          arrivalTimeInput.value = "";
          resultList.innerHTML = "";
          copyButton.style.display = "none";
          document.querySelector(
            'input[name="rally-time"][value="300"]'
          ).checked = true;
        });

        // コピーボタン
        copyButton.addEventListener("click", () => {
          if (calculatedResults.length > 0) {
            const textToCopy = calculatedResults
              .map((result) => `${result.name}：${result.time}`)
              .join("\n");

            navigator.clipboard
              .writeText(textToCopy)
              .then(() => {
                alert("計算結果をコピーしました！");
              })
              .catch((err) => {
                console.error("コピーに失敗しました:", err);
                alert(
                  "コピーに失敗しました。お手数ですが手動でコピーしてください。"
                );
              });
          }
        });
      });
    </script>
  </body>
</html>
